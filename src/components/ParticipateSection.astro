---
import Button from "./ui/Button.astro";
import Card from "./ui/Card.astro";
import Input from "./ui/Input.astro";
import Label from "./ui/Label.astro";
import FileInput from "./ui/FileInput.astro";
import Sparkles from "./icons/Sparkles.astro";

// ---- Datos Server-side (solo para el primer render y SEO, la UI ser√° client-side) ----
const TOTAL_NUMBERS = 200;
const RAFFLE_ID = "1";
const API_BASE_URL = "https://api.sorteosmdb.com/api/v1";

// Obtener unavailableNumbers desde el endpoint del backend (SSR)
let unavailableNumbers = [];
try {
  const resp = await fetch(`${API_BASE_URL}/raffles/${RAFFLE_ID}/numbers`);
  const data = await resp.json();
  if (resp.ok && data.ok) {
    unavailableNumbers = Array.isArray(data.data?.numbers)
      ? data.data.numbers.filter(
          (n: number) => typeof n === "number" && !Number.isNaN(n)
        )
      : [];
  }
} catch (err) {
  unavailableNumbers = [];
}

const numbersList = Array.from({ length: TOTAL_NUMBERS }, (_, i) => ({
  number: i + 1,
  available: !unavailableNumbers.includes(i + 1),
}));

// Dataset string for passing unavailable numbers to client
const unavailableDataset = unavailableNumbers.join(",");
---

<section id="participate-section" class="py-20 bg-gradient-card">
  <div class="container mx-auto px-4">
    <div class="max-w-2xl mx-auto">
      <div class="text-center mb-12 space-y-4">
        <div
          class="inline-flex items-center gap-2 bg-primary/10 px-4 py-2 rounded-full mb-4"
        >
          <Sparkles class="w-5 h-5 text-primary" />
          <span class="text-sm font-medium text-primary"
            >Solo $2 para participar</span
          >
        </div>
        <h2
          class="font-playfair text-4xl md:text-5xl font-bold text-foreground"
        >
          Participa Ahora
        </h2>
        <p class="text-xl text-muted-foreground">
          Completa el formulario y recibe tu c√≥digo de referido
        </p>
      </div>
      <Card class="p-8 md:p-10 bg-card shadow-glow border-border/50">
        <form id="participate-form" class="space-y-6">
          <div class="space-y-2">
            <Label htmlFor="name" class="text-base"> Nombre completo </Label>
            <Input
              id="name"
              name="name"
              placeholder="Mar√≠a Gonz√°lez"
              class="h-12 text-base"
              required
            />
          </div>
          <div class="space-y-2">
            <Label htmlFor="email" class="text-base">
              Correo electr√≥nico
            </Label>
            <Input
              id="email"
              name="email"
              type="email"
              placeholder="maria@ejemplo.com"
              class="h-12 text-base"
              required
            />
          </div>
          <div class="bg-secondary rounded-xl p-6 space-y-3">
            <h3 class="font-semibold text-lg flex items-center gap-2 mb-2">
              Selecciona tus n√∫meros para participar:
            </h3>
            <div id="number-picker-server">
              <div
                class="number-grid"
                id="astro-number-grid"
                data-unavailable-numbers={unavailableDataset}
              >
                {
                  numbersList.map(({ number, available }) => (
                    <button
                      type="button"
                      class="number-btn"
                      disabled={!available}
                      data-number={number}
                      data-unavailable={!available ? "true" : undefined}
                      aria-pressed="false"
                    >
                      {number}
                    </button>
                  ))
                }
              </div>
              <div
                class="text-center text-xs mt-2 font-medium"
                id="astro-numbers-picked-msg"
              >
                No has elegido ning√∫n n√∫mero a√∫n.
              </div>
            </div>
            <div class="text-xs text-muted-foreground mt-2 text-center">
              Algunos n√∫meros ya pueden estar tomados. Puedes elegir m√°s de uno.
            </div>
          </div>
          <Button
            id="participate-btn"
            type="button"
            size="lg"
            class="w-full bg-gradient-cta transition-all duration-300 text-lg py-6 rounded-full font-semibold"
            disabled
          >
            Selecciona al menos un n√∫mero
          </Button>
          <p class="text-center text-sm text-muted-foreground">
            Al participar aceptas nuestros t√©rminos y condiciones del sorteo
          </p>
        </form>
      </Card>
    </div>
  </div>
</section>

<!-- Modal de pago y comprobante -->
<div
  id="pago-modal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
>
  <div
    class="bg-white rounded-2xl shadow-lg w-full max-w-lg mx-auto p-8 relative"
  >
    <button
      id="pago-modal-close"
      type="button"
      class="absolute top-2 right-2 px-3 py-2 rounded-full text-gray-500 hover:bg-gray-100 focus:outline-none"
      aria-label="Cerrar"
    >
      √ó
    </button>
    <h3 class="text-2xl font-bold mb-4 text-center">Datos para el pago</h3>
    <div class="space-y-4 mb-6 text-sm text-gray-700">
      <!-- Datos de pago mejor presentados -->
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div class="border rounded-lg p-4 bg-primary/5 flex flex-col gap-2">
          <div class="flex items-center gap-2 mb-2 text-primary font-semibold">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="inline w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 17l4 4 4-4m-4-5v9"></path>
              <rect
                width="20"
                height="12"
                x="2"
                y="3"
                rx="2"
                ry="2"
                stroke="currentColor"
                stroke-width="2"
                fill="none"></rect>
            </svg>
            Pago m√≥vil
          </div>
          <ul class="text-sm text-gray-700 space-y-1">
            <li><span class="font-medium">Banco:</span> Banesco</li>
            <li><span class="font-medium">C.I.:</span> V-26387569</li>
            <li><span class="font-medium">Nombre:</span> Maukari de Brice√±o</li>
            <li><span class="font-medium">N√∫mero:</span> 0412-2638732</li>
          </ul>
        </div>
        <div class="border rounded-lg p-4 bg-secondary flex flex-col gap-2">
          <div class="flex items-center gap-2 mb-2 text-blue-700 font-semibold">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="inline w-5 h-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <rect
                width="20"
                height="12"
                x="2"
                y="6"
                rx="2"
                ry="2"
                stroke="currentColor"
                stroke-width="2"
                fill="none"></rect>
              <path
                d="M2 10h20"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"></path>
            </svg>
            Transferencia Bancaria
          </div>
          <ul class="text-sm text-gray-700 space-y-1">
            <li><span class="font-medium">Banco:</span> Banesco</li>
            <li>
              <span class="font-medium">Cuenta:</span> 0134-0030-0903-0103-9718
            </li>
            <li><span class="font-medium">C.I.:</span> V-26387569</li>
            <li><span class="font-medium">Nombre:</span> Maukari de Brice√±o</li>
          </ul>
        </div>
      </div>
      <div class="bg-secondary p-3 rounded text-xs text-gray-500 border">
        Una vez realizado el pago, adjunta el comprobante y coloca el N¬∞ de
        referencia para confirmar tu participaci√≥n.
      </div>
    </div>
    <form
      id="confirm-payment-form"
      enctype="multipart/form-data"
      class="space-y-5"
    >
      <FileInput
        id="payment-image"
        name="paymentImage"
        accept="image/*"
        required
      >
        <label
          slot="label"
          for="payment-image"
          class="block font-medium text-foreground"
        >
          Subir comprobante de pago <span class="text-red-500">*</span>
        </label>
      </FileInput>
      <div class="space-y-2">
        <Label htmlFor="payment-ref" class="text-base"
          >N¬∞ de referencia <span class="text-red-500">*</span>
        </Label>
        <Input
          id="payment-ref"
          name="paymentRef"
          type="text"
          placeholder="Ej: 123456"
          class="h-12 text-base"
          required
        />
      </div>
      <Button
        id="confirm-payment-btn"
        type="submit"
        size="lg"
        class="w-full bg-gradient-cta transition-all duration-300 text-lg py-6 rounded-full font-semibold"
      >
        Confirmar participaci√≥n
      </Button>
      <div id="payment-form-msg" class="text-center text-sm text-red-600 mt-2">
      </div>
    </form>
  </div>
</div>

<!-- Modal de √©xito con c√≥digo de referido -->
<div
  id="success-modal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
>
  <div
    class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 p-8 relative animate-scale-in"
  >
    <button
      id="success-modal-close"
      type="button"
      class="absolute top-4 right-4 px-3 py-2 rounded-full text-gray-400 hover:bg-gray-100 hover:text-gray-600 focus:outline-none transition-colors"
      aria-label="Cerrar"
    >
      ‚úï
    </button>

    <!-- Icono de √©xito -->
    <div class="flex justify-center mb-4">
      <div
        class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center"
      >
        <svg
          class="w-8 h-8 text-green-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
    </div>

    <h3 class="text-2xl font-bold mb-2 text-center text-gray-800">
      ¬°Participaci√≥n Confirmada! üéâ
    </h3>
    <p class="text-center text-gray-600 mb-6">
      Comparte tu c√≥digo y gana $0.5 por cada amigo que invite
    </p>

    <!-- C√≥digo de referido -->
    <div
      class="bg-gradient-to-br from-pink-50 to-purple-50 border-2 border-primary rounded-xl p-6 mb-6"
    >
      <p
        class="text-xs font-semibold text-gray-500 uppercase tracking-wide text-center mb-2"
      >
        Tu C√≥digo de Referido
      </p>
      <p
        id="referral-code-display"
        class="text-3xl font-bold text-primary text-center mb-4 font-mono tracking-wider"
      >
        LOADING...
      </p>

      <!-- Bot√≥n de compartir -->
      <button
        id="share-referral-btn"
        type="button"
        class="w-full bg-gradient-cta text-white font-semibold py-3 px-6 rounded-full hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
          ></path>
        </svg>
        <span id="share-btn-text">Compartir Link</span>
      </button>
    </div>

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <p class="text-sm text-blue-800 text-center">
        <strong>¬øC√≥mo funciona?</strong><br />
        Con solo 4 referidos recuperas tu inversi√≥n completa de $2
      </p>
    </div>
  </div>
</div>

<style>
  .number-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(32px, 1fr));
    grid-auto-flow: row;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  @media (min-width: 768px) {
    .number-grid {
      grid-template-columns: repeat(10, 1fr);
    }
  }

  .number-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    height: 2.5rem;
    min-width: 32px;
    max-width: 48px;
    width: 100%;
    font-weight: 500;
    cursor: pointer;
    background: white;
    border: 1.5px solid hsl(340 82% 67% / 0.14);
    color: hsl(340 15% 25%);
    transition:
      background 0.15s,
      border 0.15s,
      color 0.15s;
  }
  .number-btn:hover:not(:disabled):not(.selected):not(.unavailable) {
    background: #f7e9f2;
    /* Quitar sombra al hacer hover */
    /* No box-shadow */
  }
  .number-btn.selected {
    background: linear-gradient(135deg, hsl(340 82% 67%), hsl(330 81% 60%));
    color: white;
    border-color: hsl(340 82% 67%);
  }
  .number-btn.selected:hover {
    background: linear-gradient(135deg, hsl(340 75% 60%), hsl(330 75% 45%));
    /* Aclarar leve al hacer hover si est√° seleccionado, sin sombra */
  }
  .number-btn:disabled,
  .number-btn.unavailable {
    background: #f9d9e6;
    color: #c04a7b;
    cursor: not-allowed;
    border-color: #f9d9e6;
    opacity: 0.8;
  }
  .button-disabled {
    opacity: 0.6;
    pointer-events: none;
  }
  #pago-modal[open],
  #pago-modal.show {
    display: flex;
  }
  #pago-modal:not([open]):not(.show) {
    display: none;
  }

  #success-modal.show {
    display: flex;
  }
  #success-modal:not(.show) {
    display: none;
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-scale-in {
    animation: scaleIn 0.3s ease-out;
  }
</style>

<script type="module">
  // CLIENT SIDE SELECTION ONLY
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("astro-number-grid");
    const API_BASE_URL = "https://api.sorteosmdb.com/api/v1";
    const RAFFLE_ID = "1";
    const numberButtons = new Map();
    let unavailableNumbers = [];
    if (grid) {
      const datasetVal = grid.dataset.unavailableNumbers;
      if (datasetVal) {
        unavailableNumbers = datasetVal
          .split(",")
          .map((n) => parseInt(n, 10))
          .filter((n) => !isNaN(n));
      }
    }

    const selectedNumbers = new Set();
    const unavailableSet = new Set(unavailableNumbers);
    const PARTICIPATION_COST = 2;

    const btn = document.getElementById("participate-btn");

    function renderPicked() {
      const msg = document.getElementById("astro-numbers-picked-msg");
      if (!msg) return;
      if (selectedNumbers.size > 0) {
        msg.innerHTML = `N√∫meros elegidos: <span style="color: hsl(340 82% 67%)">${Array.from(
          selectedNumbers
        )
          .sort((a, b) => a - b)
          .join(", ")}</span>`;
      } else {
        msg.textContent = "No has elegido ning√∫n n√∫mero a√∫n.";
      }
      renderButtonAndCost();
    }

    function renderButtonAndCost() {
      if (!btn) return;
      const count = selectedNumbers.size;
      if (count > 0) {
        btn.disabled = false;
        btn.textContent = `Participar por $${count * PARTICIPATION_COST}`;
        btn.classList.remove("button-disabled");
      } else {
        btn.disabled = true;
        btn.textContent = `Selecciona al menos un n√∫mero`;
        btn.classList.add("button-disabled");
      }
    }

    function markButtonAsUnavailable(btnNum) {
      if (!btnNum) return;
      btnNum.classList.remove("selected");
      btnNum.setAttribute("aria-pressed", "false");
      btnNum.classList.add("unavailable");
      btnNum.disabled = true;
      btnNum.dataset.unavailable = "true";
    }

    function applyUnavailableState(numbers = []) {
      numbers
        .filter((n) => typeof n === "number" && !Number.isNaN(n))
        .forEach((number) => {
          unavailableSet.add(number);
          const btnNum = numberButtons.get(number);
          markButtonAsUnavailable(btnNum);
          if (selectedNumbers.has(number)) {
            selectedNumbers.delete(number);
          }
        });
      renderPicked();
    }

    async function fetchUnavailableNumbersFromAPI() {
      try {
        const resp = await fetch(
          `${API_BASE_URL}/raffles/${RAFFLE_ID}/numbers`
        );
        const data = await resp.json();
        if (resp.ok && data.ok) {
          applyUnavailableState(data.data?.numbers ?? []);
        }
      } catch (error) {
        console.warn("No se pudieron actualizar los n√∫meros", error);
      }
    }

    // Solo cambia las clases para selecci√≥n (no re-render ni eliminaci√≥n de nodos)
    if (grid) {
      Array.from(grid.querySelectorAll(".number-btn")).forEach((btnNum) => {
        const number = parseInt(btnNum.dataset.number, 10);
        numberButtons.set(number, btnNum);
        const isUnavailable =
          btnNum.dataset.unavailable === "true" || btnNum.disabled;

        if (!isUnavailable) {
          btnNum.addEventListener("click", () => {
            if (selectedNumbers.has(number)) {
              selectedNumbers.delete(number);
              btnNum.classList.remove("selected");
              btnNum.setAttribute("aria-pressed", "false");
            } else {
              if (unavailableSet.has(number)) {
                markButtonAsUnavailable(btnNum);
                return;
              }
              selectedNumbers.add(number);
              btnNum.classList.add("selected");
              btnNum.setAttribute("aria-pressed", "true");
            }
            renderPicked();
          });
        }
      });
    }

    renderPicked();
    applyUnavailableState(unavailableNumbers);
    fetchUnavailableNumbersFromAPI();

    // Modal
    const modal = document.getElementById("pago-modal");
    const closeModalButton = document.getElementById("pago-modal-close");
    const paymentForm = document.getElementById("confirm-payment-form");
    const paymentMsg = document.getElementById("payment-form-msg");

    function openModal() {
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function closeModal() {
      modal.classList.remove("show");
      document.body.style.overflow = "";
      if (paymentForm) paymentForm.reset();
      if (paymentMsg) paymentMsg.textContent = "";
    }

    if (closeModalButton) {
      closeModalButton.addEventListener("click", closeModal);
    }
    // Cerrar modal al click fuera
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    // Bot√≥n principal abre modal (NO submit del primer form)
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      // Validaciones
      const name = document.getElementById("name")?.value?.trim();
      const email = document.getElementById("email")?.value?.trim();
      if (!name || !email) {
        alert("Por favor completa todos los campos para participar.");
        return;
      }
      if (selectedNumbers.size === 0) {
        alert("Por favor selecciona al menos un n√∫mero para participar.");
        return;
      }
      openModal();
    });

    // Confirmar participaci√≥n (modal)
    paymentForm?.addEventListener("submit", async function (e) {
      e.preventDefault();
      const name = document.getElementById("name")?.value?.trim();
      const email = document.getElementById("email")?.value?.trim();
      const numbers = Array.from(selectedNumbers).sort((a, b) => a - b);
      const paymentImageInput = document.getElementById("payment-image");
      const paymentImage = paymentImageInput?.files?.[0];
      const paymentRefInput = document.getElementById("payment-ref");
      const paymentRef = paymentRefInput?.value?.trim();

      // Chequeo espec√≠fico para los campos requeridos en el modal de pago
      if (!paymentRef) {
        paymentMsg.textContent =
          "Por favor ingresa el N¬∞ de referencia de pago.";
        paymentRefInput?.focus();
        return;
      }
      if (!paymentImage) {
        paymentMsg.textContent =
          "Por favor adjunta el comprobante de pago (imagen obligatoria).";
        paymentImageInput?.focus();
        return;
      }
      // Validaciones b√°sicas
      if (!name || !email || numbers.length === 0) {
        paymentMsg.textContent = "Por favor llena todos los campos requeridos.";
        return;
      }

      // Limpiar mensajes anteriores
      paymentMsg.textContent = "";
      paymentMsg.className = "text-center text-sm mt-2";

      const formData = new FormData();
      formData.append("name", name);
      formData.append("email", email);
      formData.append("numbers", JSON.stringify(numbers));
      formData.append("paymentRef", paymentRef);
      formData.append("paymentImage", paymentImage);
      const storedReferral = localStorage.getItem("referralCode");
      if (storedReferral) {
        formData.append("referredBy", storedReferral);
      }

      // Llamar a la API del backend
      const submitButton = document.getElementById("confirm-payment-btn");
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = "Enviando...";
      }

      try {
        const resp = await fetch(
          "https://api.sorteosmdb.com/api/v1/participants",
          {
            method: "POST",
            body: formData,
          }
        );

        const data = await resp.json();

        if (resp.ok && data.ok) {
          console.log("data", data);
          paymentMsg.textContent = "";
          paymentMsg.className = "text-center text-sm text-green-600 mt-2";
          paymentMsg.textContent = "¬°Participaci√≥n confirmada exitosamente!";

          closeModal();

          // Limpia todo
          selectedNumbers.clear();
          if (grid) {
            Array.from(grid.querySelectorAll(".number-btn.selected")).forEach(
              (btnSel) => {
                btnSel.classList.remove("selected");
                btnSel.setAttribute("aria-pressed", "false");
              }
            );
          }
          const takenNumbersSuccess = data.data?.numbers_taken ?? [];
          if (
            Array.isArray(takenNumbersSuccess) &&
            takenNumbersSuccess.length > 0
          ) {
            applyUnavailableState(takenNumbersSuccess);
          }
          await fetchUnavailableNumbersFromAPI();
          renderPicked();
          document.getElementById("participate-form").reset();

          // Limpiar el input de tipo 'file' espec√≠ficamente
          const paymentImageInput = document.getElementById("payment-image");
          if (paymentImageInput instanceof HTMLInputElement) {
            paymentImageInput.value = "";
          }

          // Mostrar modal de √©xito con c√≥digo de referido
          const referralCode = data.data?.participant?.referral_code;
          if (referralCode) {
            showSuccessModal(referralCode);
          } else {
            // Fallback si no hay c√≥digo
            setTimeout(() => {
              alert(
                `¬°Participaci√≥n confirmada! Te enviaremos el c√≥digo de referido a tu correo electr√≥nico pr√≥ximamente. ¬°Gracias por participar!`
              );
            }, 100);
          }
        } else {
          // Manejar errores de la API
          const numbersTakenError = data.data?.numbers_taken ?? [];
          if (
            Array.isArray(numbersTakenError) &&
            numbersTakenError.length > 0
          ) {
            applyUnavailableState(numbersTakenError);
          }
          const errorMessage =
            data.message ||
            data.details ||
            "Error al enviar tus datos. Intenta de nuevo.";
          paymentMsg.textContent = errorMessage;
          paymentMsg.className = "text-center text-sm text-red-600 mt-2";

          // Mostrar detalles adicionales si est√°n disponibles
          if (data.details) {
            console.error("Error details:", data.details);
          }
        }
      } catch (err) {
        console.error("Error al enviar datos:", err);
        paymentMsg.textContent =
          "Error de red al enviar los datos. Verifica tu conexi√≥n e intenta nuevamente.";
        paymentMsg.className = "text-center text-sm text-red-600 mt-2";
      } finally {
        // Restaurar el bot√≥n
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = "Confirmar participaci√≥n";
        }
      }
    });

    // Resetear estado modal al cerrar
    window.addEventListener("keyup", (e) => {
      if (
        modal.classList.contains("show") &&
        (e.key === "Escape" || e.keyCode === 27)
      ) {
        closeModal();
      }
    });

    // ===== MODAL DE √âXITO CON C√ìDIGO DE REFERIDO =====
    const successModal = document.getElementById("success-modal");
    const successModalClose = document.getElementById("success-modal-close");
    const referralCodeDisplay = document.getElementById(
      "referral-code-display"
    );
    const shareReferralBtn = document.getElementById("share-referral-btn");
    const shareBtnText = document.getElementById("share-btn-text");

    let currentReferralCode = "";
    let currentReferralLink = "";

    function showSuccessModal(referralCode) {
      currentReferralCode = referralCode;
      currentReferralLink = `https://sorteosmdb.com/?r=${referralCode}`;

      if (referralCodeDisplay) {
        referralCodeDisplay.textContent = referralCode;
      }

      if (successModal) {
        successModal.classList.add("show");
        document.body.style.overflow = "hidden";
      }
    }

    function closeSuccessModal() {
      if (successModal) {
        successModal.classList.remove("show");
        document.body.style.overflow = "";
      }
    }

    // Cerrar modal de √©xito
    if (successModalClose) {
      successModalClose.addEventListener("click", closeSuccessModal);
    }

    // Cerrar al hacer click fuera del modal
    if (successModal) {
      successModal.addEventListener("click", (e) => {
        if (e.target === successModal) {
          closeSuccessModal();
        }
      });
    }

    // Cerrar con tecla Escape
    window.addEventListener("keyup", (e) => {
      if (
        successModal?.classList.contains("show") &&
        (e.key === "Escape" || e.keyCode === 27)
      ) {
        closeSuccessModal();
      }
    });

    // ===== FUNCIONALIDAD DE COMPARTIR =====
    async function shareReferralLink() {
      const shareData = {
        title: "¬°√önete al Sorteo Md'B!",
        text: `¬°Participa en el sorteo y gana incre√≠bles premios! Usa mi c√≥digo de referido: ${currentReferralCode}`,
        url: currentReferralLink,
      };

      // Verificar si Web Share API est√° disponible
      if (navigator.share) {
        try {
          await navigator.share(shareData);
          // Cambiar texto del bot√≥n temporalmente
          if (shareBtnText) {
            const originalText = shareBtnText.textContent;
            shareBtnText.textContent = "¬°Compartido!";
            setTimeout(() => {
              shareBtnText.textContent = originalText;
            }, 2000);
          }
        } catch (err) {
          // Si el usuario cancela, no hacer nada
          if (err.name !== "AbortError") {
            console.error("Error al compartir:", err);
            // Fallback a copiar al portapapeles
            copyToClipboard();
          }
        }
      } else {
        // Fallback: copiar al portapapeles
        copyToClipboard();
      }
    }

    function copyToClipboard() {
      // Intentar usar la API moderna de clipboard
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(currentReferralLink)
          .then(() => {
            if (shareBtnText) {
              const originalText = shareBtnText.textContent;
              shareBtnText.textContent = "¬°Link copiado!";
              setTimeout(() => {
                shareBtnText.textContent = originalText;
              }, 2000);
            }
          })
          .catch((err) => {
            console.error("Error al copiar:", err);
            // Fallback antiguo
            fallbackCopyToClipboard();
          });
      } else {
        // Fallback antiguo para navegadores que no soportan clipboard API
        fallbackCopyToClipboard();
      }
    }

    function fallbackCopyToClipboard() {
      const textArea = document.createElement("textarea");
      textArea.value = currentReferralLink;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand("copy");
        if (shareBtnText) {
          const originalText = shareBtnText.textContent;
          shareBtnText.textContent = "¬°Link copiado!";
          setTimeout(() => {
            shareBtnText.textContent = originalText;
          }, 2000);
        }
      } catch (err) {
        console.error("Error al copiar:", err);
        alert(
          "No se pudo copiar el link. Por favor, c√≥pialo manualmente: " +
            currentReferralLink
        );
      }

      document.body.removeChild(textArea);
    }

    // Event listener para el bot√≥n de compartir
    if (shareReferralBtn) {
      shareReferralBtn.addEventListener("click", shareReferralLink);
    }
  });
</script>
