---
import Button from "./ui/Button.astro";
import Heart from "./icons/Heart.astro";
import "swiper/css";
import "swiper/css/autoplay";
import "swiper/css/navigation";

const API_BASE_URL = "https://api.sorteosmdb.com/api/v1";
const RAFFLE_ID = "2";
const TOTAL_NUMBERS = 200;

let availableNumbers = 0;
let soldNumbers = 0;
let dateText = "El ganador serÃ¡ revelado una vez se vendan los 200 nÃºmeros";

try {
  const resp = await fetch(`${API_BASE_URL}/raffles/${RAFFLE_ID}/numbers`);
  const data = await resp.json();

  if (resp.ok && data.ok && Array.isArray(data.data?.numbers)) {
    soldNumbers = data.data.numbers.filter(
      (n: any) => typeof n === "number" && !Number.isNaN(n)
    ).length;
    availableNumbers = TOTAL_NUMBERS - soldNumbers;

    if (availableNumbers > 0) {
      dateText = `Faltan ${availableNumbers} nÃºmeros por venderse para revelar al ganador`;
    } else {
      dateText =
        "Â¡Todos los nÃºmeros han sido vendidos! Pronto revelaremos al ganador";
    }
  }
} catch (error) {
  console.error("Error fetching raffle numbers:", error);
}
---

<section
  id="hero-section"
  class="relative min-h-screen flex items-center justify-center overflow-hidden bg-gradient-hero"
  data-api-url={API_BASE_URL}
  data-raffle-id={RAFFLE_ID}
  data-total-numbers={TOTAL_NUMBERS}
>
  <div
    class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmJiZDMiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMzYgMzRjMC0yLjIxIDEuNzktNCA0LTRzNCAxLjc5IDQgNC0xLjc5IDQtNCA0LTQtMS43OS00LTR6bTAgMTBjMC0yLjIxIDEuNzktNCA0LTRzNCAxLjc5IDQgNC0xLjc5IDQtNCA0LTQtMS43OS00LTR6Ii8+PC9nPjwvZz48L3N2Zz4=')] opacity-40"
  >
  </div>

  <div class="container mx-auto px-4 py-16 relative z-10">
    <div class="flex flex-col lg:grid lg:grid-cols-2 gap-12 items-center">
      <div class="text-center lg:text-left space-y-8 animate-fade-in w-full">
        <div
          class="inline-flex items-center gap-2 bg-secondary px-4 py-2 rounded-full shadow-soft"
        >
          <Heart class="w-5 h-5 text-primary" />
          <span class="text-sm font-medium text-foreground">Sorteos Md'B</span>
        </div>

        <h1
          class="font-playfair text-5xl md:text-6xl lg:text-7xl font-bold text-foreground leading-tight"
        >
          Gana un Pack Completo de{" "}
          <span class="text-primary">L'Oreal Paris</span>
        </h1>

        <h2 class="text-uppercase text-primary text-2xl font-bold">
          HIDRA HIALURÃ“NICO
        </h2>

        <p class="text-xl md:text-2xl text-muted-foreground font-light">
          Â¡Invierte solo <span class="font-semibold text-primary">$2</span> y participa
          para ganar alguno de los 3 premios que se entregarÃ¡n al alcanzar a los 200
          participantes!
        </p>

        <div
          class="flex flex-col sm:flex-row gap-4 justify-center lg:justify-start"
        >
          <Button
            size="lg"
            class="bg-gradient-cta hover:shadow-glow transition-all duration-300 text-lg px-8 py-6 rounded-full font-semibold"
            data-scroll="participate-section"
          >
            Participar Ahora
          </Button>
          <Button
            size="lg"
            variant="outline"
            class="text-lg px-8 py-6 rounded-full border-2 font-semibold"
            data-scroll="how-it-works"
          >
            CÃ³mo Funciona
          </Button>
        </div>

        <div
          class="flex flex-wrap sm:flex-row items-center justify-center lg:justify-start gap-4 sm:gap-8 pt-2"
        >
          <div class="text-center min-w-[90px]">
            <div class="text-2xl sm:text-3xl font-bold text-primary">$2</div>
            <div class="text-sm text-muted-foreground">InversiÃ³n</div>
          </div>
          <div class="text-center min-w-[90px]">
            <div class="text-2xl sm:text-3xl font-bold text-primary">200</div>
            <div class="text-sm text-muted-foreground">Participaciones</div>
          </div>
          <div class="text-center min-w-[90px]">
            <div class="text-2xl sm:text-3xl font-bold text-primary">+$100</div>
            <div class="text-sm text-muted-foreground">En premios</div>
          </div>
        </div>
      </div>

      <div class="relative w-full space-y-6 animate-fade-in">
        <!-- Contador de nÃºmeros disponibles arriba de la imagen -->
        <div class="bg-transparent rounded-2xl p-6">
          <div class="text-center mb-4">
            <h3
              class="font-playfair text-xl md:text-2xl font-bold text-foreground mb-1"
            >
              ðŸ“Š Estado del Sorteo
            </h3>
            <p id="raffle-date-text" class="text-sm text-muted-foreground">
              {dateText}
            </p>
          </div>
          <div
            class="flex flex-row items-center justify-center gap-6 md:gap-10"
          >
            <!-- NÃºmeros Disponibles -->
            <div class="text-center">
              <div
                id="available-numbers"
                class="text-3xl md:text-4xl font-extrabold text-accent mb-1"
              >
                {availableNumbers}
              </div>
              <div class="text-xs md:text-sm text-muted-foreground font-medium">
                Disponibles
              </div>
            </div>
            <!-- Total -->
            <div class="text-center">
              <div
                id="total-numbers"
                class="text-3xl md:text-4xl font-extrabold text-foreground mb-1"
              >
                {TOTAL_NUMBERS}
              </div>
              <div class="text-xs md:text-sm text-muted-foreground font-medium">
                Total
              </div>
            </div>
          </div>
        </div>

        <div
          class="swiper mySwiper relative top-4 rounded-3xl overflow-hidden shadow-glow animate-float max-w-lg mx-auto w-full"
        >
          <div class="swiper-wrapper">
            <div class="swiper-slide relative aspect-[4/3]">
              <img
                src="/hero-image.png"
                alt="Pack completo L'Oreal Paris - Productos premium para el cabello"
                class="w-full h-full object-cover select-none block"
              />
              <div
                class="absolute bottom-0 left-0 right-0 bg-primary-600/60 backdrop-blur-sm py-3 text-center border-t border-white/10"
              >
                <span class="text-white font-playfair font-bold text-xl"
                  >Premio #1</span
                >
              </div>
            </div>
            <div class="swiper-slide relative aspect-[4/3]">
              <img
                src="/hero-image-2.png"
                alt="Pack completo L'Oreal Paris - Vista lateral"
                class="w-full h-full object-cover select-none block"
              />
              <div
                class="absolute bottom-0 left-0 right-0 bg-primary-600/60 backdrop-blur-sm py-3 text-center border-t border-white/10"
              >
                <span class="text-white font-playfair font-bold text-xl"
                  >Premio #2</span
                >
              </div>
            </div>
            <div class="swiper-slide relative aspect-[4/3]">
              <img
                src="/hero-image-3.png"
                alt="Pack completo L'Oreal Paris - Detalle productos"
                class="w-full h-full object-cover select-none block"
              />
              <div
                class="absolute bottom-0 left-0 right-0 bg-primary-600/60 backdrop-blur-sm py-3 text-center border-t border-white/10"
              >
                <span class="text-white font-playfair font-bold text-xl"
                  >Premio #3</span
                >
              </div>
            </div>
          </div>
          <div
            class="swiper-button-next !text-white drop-shadow-lg !w-8 !h-8 after:!text-2xl"
          >
          </div>
          <div
            class="swiper-button-prev !text-white drop-shadow-lg !w-8 !h-8 after:!text-2xl"
          >
          </div>
          <div
            class="absolute inset-0 bg-gradient-to-t from-primary/20 to-transparent pointer-events-none z-10"
          >
          </div>
          <div
            class="absolute -z-10 top-8 -right-8 w-72 h-72 bg-primary/20 rounded-full blur-3xl"
          >
          </div>
          <div
            class="absolute -z-10 -bottom-8 -left-8 w-96 h-96 bg-accent/20 rounded-full blur-3xl"
          >
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import Swiper from "swiper";
  import { Autoplay, Navigation } from "swiper/modules";

  // Get config from DOM
  const heroSection = document.getElementById("hero-section");
  const API_BASE_URL = heroSection?.dataset.apiUrl;
  const RAFFLE_ID = heroSection?.dataset.raffleId;
  const TOTAL_NUMBERS = parseInt(heroSection?.dataset.totalNumbers || "0");

  // Numbers update script
  async function updateNumbers() {
    if (!API_BASE_URL || !RAFFLE_ID) return;

    try {
      const resp = await fetch(`${API_BASE_URL}/raffles/${RAFFLE_ID}/numbers`);
      const data = await resp.json();

      if (resp.ok && data.ok && Array.isArray(data.data?.numbers)) {
        const soldNumbers = data.data.numbers.filter(
          (n: any) => typeof n === "number" && !Number.isNaN(n)
        ).length;
        const availableNumbers = TOTAL_NUMBERS - soldNumbers;

        const soldEl = document.getElementById("sold-numbers");
        const availableEl = document.getElementById("available-numbers");
        const dateTextEl = document.getElementById("raffle-date-text");

        if (soldEl) soldEl.textContent = soldNumbers.toString();
        if (availableEl) availableEl.textContent = availableNumbers.toString();

        if (dateTextEl) {
          if (availableNumbers > 0) {
            dateTextEl.textContent = `Faltan ${availableNumbers} nÃºmeros por venderse para revelar al ganador`;
          } else {
            dateTextEl.textContent =
              "Â¡Todos los nÃºmeros han sido vendidos! Pronto revelaremos al ganador";
          }
        }
      }
    } catch (error) {
      console.error("Error updating numbers:", error);
    }
  }

  // Actualizar cada 30 segundos
  setInterval(updateNumbers, 30000);

  // Scroll buttons script
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll("[data-scroll]");
    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        const targetId = button.getAttribute("data-scroll");
        if (targetId) {
          const element = document.getElementById(targetId);
          if (element) {
            element.scrollIntoView({ behavior: "smooth" });
          }
        }
      });
    });

    // Hero Image Slider with Swiper
    new Swiper(".mySwiper", {
      modules: [Autoplay, Navigation],
      loop: true,
      grabCursor: true,
      autoplay: {
        delay: 5000,
        disableOnInteraction: false,
      },
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
      speed: 500,
    });
  });
</script>
