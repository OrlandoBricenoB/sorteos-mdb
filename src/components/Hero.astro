---
import Button from "./ui/Button.astro";
import Heart from "./icons/Heart.astro";

const API_BASE_URL = "https://api.sorteosmdb.com/api/v1";
const RAFFLE_SLUG = "l-oreal-glycolic-gloss";

let days = 0;
let hours = 0;
let minutes = 0;
let targetDateTimestamp = new Date("2025-12-15T12:00:00").getTime();
let dateText = "Compra tus números hasta el 15 de Diciembre de 2025";

try {
  const resp = await fetch(`${API_BASE_URL}/raffles/${RAFFLE_SLUG}/status`);
  const data = await resp.json();

  if (resp.ok && data.ok && data.data?.end_at) {
    const endDate = new Date(data.data.end_at);
    targetDateTimestamp = endDate.getTime();
    const now = new Date().getTime();
    const distance = targetDateTimestamp - now;

    if (distance > 0) {
      days = Math.floor(distance / (1000 * 60 * 60 * 24));
      hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    }

    const months = [
      "Enero",
      "Febrero",
      "Marzo",
      "Abril",
      "Mayo",
      "Junio",
      "Julio",
      "Agosto",
      "Septiembre",
      "Octubre",
      "Noviembre",
      "Diciembre",
    ];
    const day = endDate.getDate();
    const month = months[endDate.getMonth()];
    const year = endDate.getFullYear();
    dateText = `Compra tus números hasta el ${day} de ${month} de ${year}`;
  }
} catch (error) {
  console.error("Error fetching raffle status:", error);
}
---

<section
  id="hero-section"
  data-target-date={targetDateTimestamp}
  class="relative min-h-screen flex items-center justify-center overflow-hidden bg-gradient-hero"
>
  <div
    class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmJiZDMiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMzYgMzRjMC0yLjIxIDEuNzktNCA0LTRzNCAxLjc5IDQgNC0xLjc5IDQtNCA0LTQtMS43OS00LTR6bTAgMTBjMC0yLjIxIDEuNzktNCA0LTRzNCAxLjc5IDQgNC0xLjc5IDQtNCA0LTQtMS43OS00LTR6Ii8+PC9nPjwvZz48L3N2Zz4=')] opacity-40"
  >
  </div>

  <div class="container mx-auto px-4 py-16 relative z-10">
    <div class="flex flex-col lg:grid lg:grid-cols-2 gap-12 items-center">
      <div class="text-center lg:text-left space-y-8 animate-fade-in w-full">
        <div
          class="inline-flex items-center gap-2 bg-secondary px-4 py-2 rounded-full shadow-soft"
        >
          <Heart class="w-5 h-5 text-primary" />
          <span class="text-sm font-medium text-foreground">Sorteos Md'B</span>
        </div>

        <h1
          class="font-playfair text-5xl md:text-6xl lg:text-7xl font-bold text-foreground leading-tight"
        >
          Gana un Pack Completo de{" "}
          <span class="text-primary">L'Oreal Paris</span>
        </h1>

        <h2 class="text-uppercase text-primary text-2xl font-bold">
          ELVIVE GLYCOLIC GLOSS
        </h2>

        <p class="text-xl md:text-2xl text-muted-foreground font-light">
          ¡Invierte solo <span class="font-semibold text-primary">$2</span> y participa
          para ganar productos originales que harán brillar tu cabello toda la navidad!
        </p>

        <div
          class="flex flex-col sm:flex-row gap-4 justify-center lg:justify-start"
        >
          <Button
            size="lg"
            class="bg-gradient-cta hover:shadow-glow transition-all duration-300 text-lg px-8 py-6 rounded-full font-semibold"
            data-scroll="participate-section"
          >
            Participar Ahora
          </Button>
          <Button
            size="lg"
            variant="outline"
            class="text-lg px-8 py-6 rounded-full border-2 font-semibold"
            data-scroll="how-it-works"
          >
            Cómo Funciona
          </Button>
        </div>

        <div
          class="flex flex-wrap sm:flex-row items-center justify-center lg:justify-start gap-4 sm:gap-8 pt-2"
        >
          <div class="text-center min-w-[90px]">
            <div class="text-2xl sm:text-3xl font-bold text-primary">$2</div>
            <div class="text-sm text-muted-foreground">Inversión</div>
          </div>
          <div class="text-center min-w-[90px]">
            <div class="text-2xl sm:text-3xl font-bold text-primary">200</div>
            <div class="text-sm text-muted-foreground">Participaciones</div>
          </div>
          <div class="text-center min-w-[90px]">
            <div class="text-2xl sm:text-3xl font-bold text-primary">+$60</div>
            <div class="text-sm text-muted-foreground">Valor del Premio</div>
          </div>
        </div>
      </div>

      <div class="relative w-full space-y-6 animate-fade-in">
        <!-- Countdown arriba de la imagen -->
        <div class="bg-transparent rounded-2xl p-6">
          <div class="text-center mb-4">
            <h3
              class="font-playfair text-xl md:text-2xl font-bold text-foreground mb-1"
            >
              ⏰ ¡Ya falta poco para elegir al ganador!
            </h3>
            <p id="raffle-date-text" class="text-sm text-muted-foreground">
              {dateText}
            </p>
          </div>
          <div
            class="flex flex-row items-center justify-center gap-6 md:gap-10"
          >
            <!-- Días -->
            <div class="text-center">
              <div
                id="days"
                class="text-3xl md:text-4xl font-extrabold text-primary mb-1"
              >
                {days}
              </div>
              <div class="text-xs md:text-sm text-muted-foreground font-medium">
                Días
              </div>
            </div>
            <!-- Horas -->
            <div class="text-center">
              <div
                id="hours"
                class="text-3xl md:text-4xl font-extrabold text-primary mb-1"
              >
                {hours.toString().padStart(2, "0")}
              </div>
              <div class="text-xs md:text-sm text-muted-foreground font-medium">
                Horas
              </div>
            </div>
            <!-- Minutos -->
            <div class="text-center">
              <div
                id="minutes"
                class="text-3xl md:text-4xl font-extrabold text-primary mb-1"
              >
                {minutes.toString().padStart(2, "0")}
              </div>
              <div class="text-xs md:text-sm text-muted-foreground font-medium">
                Minutos
              </div>
            </div>
          </div>
        </div>

        <div
          class="relative top-4 rounded-3xl overflow-hidden shadow-glow animate-float"
        >
          <img
            src="/hero-image.png"
            alt="Pack completo L'Oreal Paris - Productos premium para el cabello"
            class="w-full h-auto object-cover"
            onerror="this.src='https://via.placeholder.com/600x800/ff6b9d/ffffff?text=L%27Oreal+Paris+Pack'"
          />
          <div
            class="absolute inset-0 bg-gradient-to-t from-primary/20 to-transparent"
          >
          </div>
          <div
            class="absolute -z-10 top-8 -right-8 w-72 h-72 bg-primary/20 rounded-full blur-3xl"
          >
          </div>
          <div
            class="absolute -z-10 -bottom-8 -left-8 w-96 h-96 bg-accent/20 rounded-full blur-3xl"
          >
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Countdown script
  const targetDate = parseInt(
    document.getElementById("hero-section")?.dataset.targetDate || "0"
  );

  function updateCountdown() {
    const now = new Date().getTime();
    const distance = targetDate - now;

    if (distance < 0) {
      const daysEl = document.getElementById("days");
      const hoursEl = document.getElementById("hours");
      const minutesEl = document.getElementById("minutes");
      if (daysEl) daysEl.textContent = "0";
      if (hoursEl) hoursEl.textContent = "0";
      if (minutesEl) minutesEl.textContent = "0";
      return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor(
      (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
    );
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

    const daysEl = document.getElementById("days");
    const hoursEl = document.getElementById("hours");
    const minutesEl = document.getElementById("minutes");

    if (daysEl) daysEl.textContent = days.toString();
    if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, "0");
    if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, "0");
  }

  // Actualizar inmediatamente
  updateCountdown();

  // Actualizar cada minuto
  setInterval(updateCountdown, 60000);

  // Scroll buttons script
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll<HTMLElement>("[data-scroll]");
    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        const targetId = button.getAttribute("data-scroll");
        if (targetId) {
          const element = document.getElementById(targetId as string);
          if (element) {
            element.scrollIntoView({ behavior: "smooth" });
          }
        }
      });
    });
  });
</script>
